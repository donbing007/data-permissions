apiVersion: apps/v1beta2
kind: Deployment
metadata:
    name: {{ template "xplat-data-permissions.fullname" . }}
    labels:
        app: {{ template "xplat-data-permissions.name" . }}
        chart: {{ template "xplat-data-permissions.chart" . }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
spec:
    replicas: {{ .Values.replicaCount }}
    selector:
        matchLabels:
            app: {{ template "xplat-data-permissions.name" . }}
            release: {{ .Release.Name }}
    template:
        metadata:
            labels:
                app: {{ template "xplat-data-permissions.name" . }}
                release: {{ .Release.Name }}
                {{- with .Values.annotations }}
            annotations:
{{ toYaml . | indent 14 }}
            {{- end }}
        spec:
            containers:
               {{- if .Values.jdbc.init.enabled}}
                - name: init-db
                  image: "luanpeng/lp:database-tools-1.0"
                  imagePullPolicy: IfNotPresent
                  env:
                      - name: DRIVER_NAME
                        value: "com.mysql.jdbc.Driver"
                      - name: URL
                        value: "jdbc:mysql://{{ .Values.jdbc.host}}:{{ .Values.jdbc.port}}/{{ .Values.jdbc.dbname }}?useUnicode=true&characterEncoding=utf8&useSSL=false"
                      - name: USERNAME
                        value: {{ .Values.jdbc.userName }}
                      - name: PASSWORD
                        value: {{ .Values.jdbc.password }}
                  volumeMounts:
                      - mountPath: /root/db_tools/script/execute.sql
                        name: config
                        subPath: initdb.sql
                {{- end }}
                - name: {{ .Chart.Name }}
                  image: "{{ .Values.image.repository }}:{{ template "image.tag" . }}"
                  imagePullPolicy: {{ .Values.image.pullPolicy }}
                  env:
                    - name: JVM_HEAP_PERCENTAGE
                      value: 50
                  command: ["java"]
                  args:
                    - -jar
                    {{- range .Values.jvm }}
                    - {{ . }}
                    {{- end }}
                    - /xplat/xplat-data-permissions.jar
                    - --spring.config.location=/xplat/application.yml
                  ports:
                      - name: http-metrics
                        containerPort: 8080
                        protocol: TCP
                      - name: grpc
                        containerPort: 8206
                        protocol: TCP
                  volumeMounts:
                      - mountPath: /xplat/application.yml
                        name: config
                        subPath: application.yml
                      - mountPath: /xplat/j2cache/j2cache.properties
                        name: config
                        subPath: j2cache.properties
                  livenessProbe:
                      httpGet:
                          scheme: HTTP
                          path: /actuator/health
                          port: http-metrics
                      initialDelaySeconds: 30
                      periodSeconds: 60
                      failureThreshold: 3
                      timeoutSeconds: 30
                  readinessProbe:
                      httpGet:
                          scheme: HTTP
                          path: /actuator/health
                          port: http-metrics
                      initialDelaySeconds: 30
                      periodSeconds: 60
                      failureThreshold: 3
                      timeoutSeconds: 30
                  resources:
{{ toYaml .Values.resources | indent 20 }}
                {{- if .Values.affinity }}
                {{- with .Values.affinity }}
            affinity:
{{ toYaml . | indent 14 }}
                {{- end }}
                {{- else }}
            volumes:
                - name: config
                  configMap:
                      name: {{ template "xplat-data-permissions.fullname" . }}-configmap
            affinity:
                podAntiAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        - topologyKey: "kubernetes.io/hostname"
                          labelSelector:
                              matchLabels:
                                  app: {{ template "xplat-data-permissions.name" . }}
                                  release: {{ .Release.Name }}
                {{- end }}
                {{- with .Values.nodeSelector }}
            nodeSelector:
{{ toYaml . | indent 14 }}
                {{- end }}
                {{- with .Values.tolerations }}
            tolerations:
{{ toYaml . | indent 14 }}
        {{- end }}
